FROM ubuntu:14.10
MAINTAINER Krzysztof Trzepla <krzysztof.trzepla@gmail.com>

# Add custom package sources
RUN apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 828AB726
ADD https://raw.githubusercontent.com/spawngrid/kerl/master/kerl /root/kerl
RUN chmod a+x /root/kerl

# Get the image up to date
RUN apt-get update && \
    apt-get dist-upgrade -y && \
    apt-get clean

# Install basic packages
RUN apt-get install -y build-essential clang cmake git curl openssl libssl-dev \
                       libmozjs185-dev libicu-dev libcurl4-gnutls-dev libtool && \
    apt-get clean

# Install erlang R15B03-1
RUN /root/kerl build R15B03-1 R15B03-1 && \
    /root/kerl install R15B03-1 /opt/erlang/R15B03 && \
    . /opt/erlang/R15B03/activate

# Set up the environment
ENV HOME /root
ENV PATH /opt/erlang/R15B03/bin:$PATH

# Install bigcouch
RUN git clone https://github.com/cloudant/bigcouch.git /root/bigcouch && \
    cd /root/bigcouch && \
    ./configure && \
    make && \
    make install